---
title: IPv4
date: 2025-07-23
icon: 'earth-americas'
order: 21
category: 
    - '408'
    - '计算机网络'
    - 考研
---

## IPv4 协议

![各层协议之间关系](//store.s1r0ko.top/svg/m/cn/21/1_ver_1.svg)

::: tip

各层协议之中， **IP 协议（Internet Protocol）是互联网的核心**{#red-msg}

ARP 协议用于查询同一网络中的 `<主机 IP 地址, MAC 地址>` 之间的映射关系

ICMP 协议用于网络层实体之间互相通知“异常事件”

IGMP 协议用于实现 IP 组播

:::

## IP 数据报的格式

![IP 数据报的格式](//store.s1r0ko.top/svg/m/cn/21/2_ver_2.svg)

IP 数据报分为**首部**和**数据部分**两个部分

首部的结构如图所示

::: info 首部

首部分为固定部分和可变部分两个部分

固定部分长度为 **20 字节**，可变部分长度为 **0 ~ 40 字节不等**

各部分详解：

- 固定部分

| 字段名 | bit 位数 | 说明 |
| ---- | ---- | ---- |
| 版本 | 4 | 用于区分网络层使用的 IP 协议版本，使用二进制表示 4 就是 IPv4 协议，使用二进制表示 6 就是 IPv6 协议 |
| 首部长度 | 4 | 用于指示 IP 数据报的首部长度，单位为 4B，例如：一个首部长度为 20 B 的 IP 数据报，这里的内容为二进制表示的 5 即 $5 \times 4B = 20B$ |
| ~~区分服务~~ | 8 | ~~一般用不到， 408 不考~~ |
| 总长度 | 16 | 表示范围 0 ~ 65535 单位为 1B ，表示整个 IP 数据报的长度（首部 + 数据部分） |
| 标识 | 16 | 由 IP 数据报的“源主机”生成，通常是自增序列，相当于一个数据报的识别码，数据报进行分片时，各分片的标识码必须相同 |
| 标志[^1] | 3 | 三个 bit 分别为三个不同含义，最低位 MF 、 次低位 DF 、 最高位不需要了解意思，具体指代详见脚注 1，假设一个标志位为 001 则分别为最高位、 次低位 MF 、 最低位 DF |
| 片偏移 | 13 | 表示该数据部分在“被分片”之前所处的位置，以 8 B 为单位 |
| 生存时间 | 8 | 代表该数据报在网络中可通过的路由器数的最大值。常记为 TTL[^2] |
| 协议 | 8 | 表示当前数据报正在为哪一个协议服务，如果是 TCP 该值设置为 6 、 如果是 UDP 该值设置为 17 |
| 首部校验和 | 16 | 经过的每个路由器都会对首部进行校验（不校验数据部分），如果该字段全设为 0 ，表示不用校验；校验和的计算方法与 UDP 相同 |
| 源地址 | 32 | 发送主机的 IP 地址 |
| 目的地址 | 32 | 接收主机的 IP 地址 |

[^1]: 标识位含义对照表：
    | 标志位 | 值 | 含义 |
    | --- | --- | --- |
    | MF | 0 | 表示当前分片是 IP 数据报的最后一个分片 |
    | MF | 1 | 表示当前分片不是 IP 数据报的最后一个分片，后面还有分片 |
    | DF | 0 | 表示 IP 数据报可以进行分片 |
    | DF | 1 | 表示 IP 数据报不能进行分片 |

[^2]: 生存时间 TTL ：
    - TTL 的初始值通常由源主机设置
    - 每经过一个路由器， TTL 就会减 1
    - 当 TTL 减为 0 时，该数据报就会被丢弃，并且向源主机发送 ICMP 报文代表发生异常发送失败

- 可变部分

| 字段名 | bit 位数 | 说明 |
| --- | --- | --- |
| 填充 | 不定长 | 用于将 IP 数据报首部填充至 4B 的整数倍 |

:::

::: info 数据部分

数据部分长度范围：0 B ~ ( 65535 - 20 ) B ，扣掉的 20 B 为首部的最小长度，值不需要记

上面只是受到首部总长度字段的限制，也就是**理论最大值**，实际上 IP 数据报的长度通常会受到数据链路层的最短 / 长帧长的限制

:::

一个数据链路层数据帧能承载的最大数据量称为最大传输单元（MTU）。如[以太网帧](/art/learning/master/major/ComputerNetworks/LocalAreaNetwork.html#v2-标准的以太网-mac-帧) MTU = 1500 B

如果一个 IP 数据报总长度超出了下一段链路的 MTU 就需要进行分片处理，依次传递这些分片给下一个节点

拆分时需要注意需要按 MTU 大小减去 IP 数据报的首部长度，得到的数据部分长度才是分片后的数据长度

::: warning

- IP 数据报的“分片”可能在源主机或任何一个路由器中发生

- 只有目的主机才会对分片进行**“重组”**

- 各分片有可能以乱序到达目的主机

- 由于首部“片偏移”字段是以 **8 B** 为单位，因此，除**最后一个分片**外，其他每个分片的数据部分必须是 **8 B** 的整数倍

- **当标志位 DF = 1 且下一段数据链路层数据帧长也无法满足这一份数据报时，路由器会选择丢弃该数据报，并且向源主机发送 ICMP 报文代表发生异常发送失败**{#red-msg}

- 4 1 8，首部长度 4B 为单位，总长度 1B 为单位，片偏移 8B 为单位

:::

## IP 地址详解

IP 地址是一个 32 位的二进制数，通常用点分十进制的形式表示，例如： 192.168.1.1

IP 地址资源由 ICANN（互联网名字与数字分配机构）进行分配（有偿分配）

ICANN 将 IP 地址分为以下几类（如图）：

![IP 地址分类](//store.s1r0ko.top/svg/m/cn/21/3_ver_1.svg)

::: info IP 地址

一个 IP 地址由两部分组成： 网络号 + 主机号

这两个号不定长，需要根据不同种类的 IP 地址而定

| IP 地址类型 | 网络号长度 | 主机号长度 | 网络号前几位固定位 | 前八位表示的十进制数范围 |
| --- | --- | --- | --- | --- |
| A 类 | 8 位 | 24 位 | 0 | 0 ~ 126 |
| B 类 | 16 位 | 16 位 | 10 | 128 ~ 191 |
| C 类 | 24 位 | 8 位 | 110 | 192 ~ 223 |
| D 类 | 无 | 无 | 1110 | 224 ~ 239 |
| E 类 | 无 | 无 | 1111 | 240 ~ 255 |

:::

::: warning

- 在早期互联网时代，每台主机，每个路由器接口被分配的 IP 地址都是全球唯一的

- 路由器和路由器连接的接口可以不分配 IP 地址，但路由器和其他节点连接的接口必须分配 IP 地址

- 从属于同一个网络的所有主机、路由器接口和 IP 地址“网络号”都相同

- 当一台新主机接入网络时，需要给他分配一个 IP 地址、并配置“默认网关”

:::

- 单播地址：每一个 IP 对应一台主机

- 多播地址：每一个 IP 可以分配给一个主机群，向一个多播地址发送信息，就是向这一群主机发送信息

### IP 转发示例

假设有如下网络拓扑：

![IP 转发示例](//store.s1r0ko.top/svg/m/cn/21/4_ver_2.svg)

- 某学校被分配的 IP 网络号为 `166.1.0.0`

- 某公司被分配的 IP 网络号为 `200.1.1.0`

现有一个 IP 数据报从 H1 发送到 H7，结构如下：

| 源 IP | 目的 IP | 
| --- | --- | 
| 166.1.0.1 | 200.1.1.2 | 

过程大致如下：

1. H1 完成数据报的组装后比较网络段和自身网络段是否处在一个局域网内，发现不是，所以发往网关（每个节点都会保存该局域网的网关 IP ），组帧需要目的 MAC 地址，通过 ARP 协议可以根据节点内部的网关 IP 获取到网关 MAC 地址，完成组帧后发往连接该节点的交换机

2. 交换机获取到 MAC 帧后，会根据 MAC 转发到网关

3. 网关收到多个 MAC 帧并完成组装 IP 数据报后，会根据目的 IP 地址查询转发表转发到对应端口

4. 根据图片可知，此时学校网关有到达目的网段的路由，所以会将数据报发往该路由，发往公司的网关

5. 公司路由器收到该数据报，确认是发往公司网段，此时通过组帧可以获取到目标 IP 主机的 MAC 地址，发送 MAC 帧发往公司的交换机

6. 交换机确认 MAC 地址，发送到对应主机

现有一个 IP 数据报从 H1 发送到 H6，结构如下：

| 源 IP | 目的 IP | 
| --- | --- | 
| 166.1.0.1 | 166.1.4.4 | 

1. H1 组装完数据报后，检查到目的 IP 和自己处于同一个网段中，于是通过 ARP 协议获取到目的 IP 主机的 MAC 地址，组帧后发往交换机

2. 交换机收到数据报后，会根据 MAC 地址直接转发到 H6 或下一个交换机节点，直到到达目的主机

3. 到达目的主机后，目的主机会先检查 MAC 地址是否是自己，确认后组装成 IP 数据报，再确认目的 IP 地址是否是自己，确认后转交给上一层处理

### 一些特殊用途的 IP 地址

| 网络号 | 主机号 | 是否可以作为分组源地址 | 是否可以作为分组目的地址 | 含义 |
| --- | --- | --- | --- | --- |
| Y | 全 0 | **否**{#red-msg} | **否**{#red-msg} | 表示整个网络本身（仅能用于路由表、转发表） |
| Y | 全 1 | **否**{#red-msg} | **是**{#blue-msg} | 向网络号为 Y 的网络广播 IP 分组 |
| 0 | Y | **是**{#blue-msg} | **否**{#red-msg} | 表示本网络中主机号为 Y 的主机 |
| 全 0 | 全 0 | **是**{#blue-msg} | **否**{#red-msg} | 本网络上的本主机（ DHCP 协议中会使用） |
| 全 1 | 全 1 | **否**{#red-msg} | **是**{#blue-msg} | 向本网络广播 IP 分组 |
| 127 | 非全 0 或非全 1 的任何数 | **是**{#blue-msg} | **是**{#blue-msg} | 环回自检地址，表示一台主机本身，用于本地软件的环回测试 |

::: warning 

- 以上这些特殊地址不能指派给网络中的任何一台主机或路由器“私用”

- 主机号占 N bit ，那么这个网络中最多支持 $2^N - 2$ 个主机或路由器

:::

## 子网划分和子网掩码

假设以下情况：

- 某学校被分配 B 类地址段 `166.1.0.0` ，并且使用**子网划分技术**分配两个子网

- 某公司被分配 C 类地址段 `200.1.1.0` 

如图：

![子网划分](//store.s1r0ko.top/svg/m/cn/21/5_ver_1.svg)

子网划分通过将主机位前 N 位拿出来作为子网号，将主机位后 M 位拿出来作为主机号，来实现子网的划分

比如此图就是将主机位第一位作为子网位，因此可以分为两个子网

假设有以下几种情况，分析数据传输过程

- **H3 向 H6 发送数据报（同一子网内的两台主机）**

H3 在发送数据之前，构造完 IP 数据报后，会将源 IP 地址和目的 IP 地址与子网掩码进行“与运算”，并对结果进行对比，发现网络前缀相同，说明 H6 和 H3 位于同一个子网下，随后可以直接生成 MAC 帧，找到 H6 的 MAC 地址，直接发送给交换机进行转发，到达 H6 后， H6 会将 MAC 组装成 IP 数据报，对比发现目的地址是自己，就接收数据

- **H1 向 H3 发送数据报（不同子网内的两台主机）**

H1 构建数据报之后计算对比发现，源地址和目的地址不在一个子网内，会通过 ARP 协议获取到路由器的 MAC 地址，于是组装 MAC 帧发往路由器；路由器收到并完成组装数据报后，会对目的 IP 地址使用转发表进行计算，得到网络前缀后查询转发表，发现目的网络前缀在特定接口，于是发往对应接口，目的主机 MAC 地址通过 ARP 协议得到，到达交换机后，传输给 H3 

- **H1 向 H7 发送数据报（采用子网划分技术的网络向传统网络发送）**

对于有子网划分技术的路由器在存转发表时，对于连接传统路由器的接口，需要将**子网掩码项设置为“默认子网掩码”**不同类型的网络需要配置不同的子网掩码，具体在下面思维导图的表格中，这样才能正确地将数据报转发到传统网络中，这里 H1 向路由器发送数据报，路由器比对后发现由 B0 接口发出，然后到达公司路由器，该传统路由器识别出目的地址的网络类型 （ A / B / C ） 类，并将对应的网络号拆分出来，与交换表进行比对，确定为在本局域网内，通过 ARP 协议得到目的主机 MAC 地址，交由交换机，最后到达目的主机

- **H7 向 H1 发送数据报（传统网络向采用子网划分技术的网络发送）**

H7 完成数据报的封装，对目的地址进行检查，发现不在自己的网络内，于是将数据报发往路由器，路由器根据其网络类型切分网络号，查询交换表后发往对应接口，到达学校路由器后，路由器使用子网掩码进行一一计算，得到对应的子网端口，并通过 ARP 获取目的主机的 MAC 地址发送给交换机最后到达目的地址

- **主机 H1 发往 Internet 的某个 IP 数据报如何传输？ （假设目的 IP 地址为 111.2.3.4）**

H1 使用子网掩码计算自己和目的 IP 地址，发现不在同一个网络，于是将 IP 数据报通过 MAC 地址发往网关，网关收到数据报后，使用各子网掩码对目的地址进行计算，发现目的地址不在自己的路由表内，于是发往默认路由（0.0.0.0）也就是 B1 ，到达 ISP 后， ISP 路由器也进行计算比对发现也不在自己的路由表内，于是发往其他，也就是 A1 最后经过层层路由器转发会最终到达 Internet 的某一节点

```markmap
---
markmap:
  colorFreezeLevel: 4
  maxWidth: 400
---

# 子网划分技术

## 子网划分

### 原理

- 若某单位租用了一个 IP 地址段，假设原本主机号占 $n$ bit 那么可以将前 $k$ bit 扣出来当**子网号**，用剩余的 $n - k$ bit 作为**主机号**，这样就能划分出 $2^k$ 个子网（每个子网包含的 IP 地址块大小相等）

### 子网划分前后 IP 结构变化

- 划分前：**两级结构**

    - <网络号, 主机号>

- 划分后：**三级结构**

    - <网络号, 子网号, 主机号>

### 注意

- 每个子网地址中，主机号**不能分配为全 0 或全 1** —— 全 0 代表子网自身，全 1 代表子网广播地址

## 子网掩码

### 作用

- 用子网掩码、 IP 地址“逐位进行与运算”，算出 **<网络号, 子网号>** （可合称“网络前缀”）

- 只有网络前缀相同的 IP 地址，才归属于同一个网络（子网）

### 注意

- 如果一个网络内部**进行了子网划分**，那么这个网络中的**每台主机、每个路由器接口**都需要配置 **IP 地址、默认网关、子网掩码**

- 如果一台路由器支持子网划分技术，那么在它的转发表中，需要包含 <目的网络号, 子网掩码, 转发接口> 这三个字段

## 默认子网掩码

- 如果一个传统网络（ A / B / C 类）内部**没有进行子网划分**，那么可以将对应此网络的转发表**子网掩码项设置为“默认子网掩码”**

    - | 网络类别 | 默认子网掩码 |
      | --- | --- |
      | A 类 | 255.0.0.0 |
      | B 类 | 255.255.0.0 |
      | C 类 | 255.255.255.0 |

## 默认路由

### 默认路由（默认转发表项）设置：<目的网络号全为 0 , 子网掩码全 0 >

### 在路由转发表中，如果所有表项都不匹配，那么将由**默认路由**转发出去

```

### 主机发送数据报的过程

1. 判断目的主机和本机是否属于同一个网络

    1. 检查本机 IP 地址和目的 IP 地址的网络前缀是否相同（需要用本机配置的子网掩码进行“逐位与”运算）

    2. 若两个网络前缀相同，说明目的主机和本机属于同一个网络；若网络前缀不同，说明不属于同一个网络

2. 将 IP 数据报封装成 MAC 帧并发送到链路上

    1. 如果目的主机与本机**属于同一个网络**，就通过 ARP 协议找到**目的主机**的 MAC 地址，再将 IP 数据报封装成帧，并将帧转发给**目的主机**

    2. 如果目的主机与本机**不属于同一个网络**，就通过 ARP 协议找到**默认网关**的 MAC 地址，再将 IP 数据报封装成帧，并将帧转发给**默认网关**

### 路由器转发数据报的过程

1. 从路由器某个接口收到一个 IP 数据报

2. 对 IP 数据报首部进行校验，并从中找到**目的 IP 地址**

3. 查“转发表”

    1. 转发表项包含<目的网络号, 子网掩码, 转发接口>

    2. 检查目的 IP 地址与每个表项是否匹配（将目的地址、子网掩码“逐位与”运算，若结果和某个目的网络号相同，说明匹配）

    3. 最后一定会和默认路由匹配（默认路由的子网掩码为 0.0.0.0 所有 IP 和其进行“逐位与”运算，结果都为 0.0.0.0），并转发出去

4. 转发

    1. 根据查找转发表的结果，将 IP 数据报从对应的接口转发出去

    2. 如果匹配的转发接口和该 IP 数据报的入口相同，就不会再将该数据报转发回去

::: tip

在一个局域网内有多个子网的情况下，可以使用多个路由器进行相互连接，可以降低路由器的负载，提升数据传输效率，只有**一个**路由器负责和外界互联网通信，这样的局域网称为一个自治系统（AS）

:::

### CIDR

CIDR （Classless Inter-Domain Routing），无类别域间路由选择协议也称无分类编址，是一种用于分配 IP 地址和路由信息的协议，它的作用是**减少 IP 地址的浪费**，并**提高路由效率**

在上世纪 90 年代，对于每台主机一个全球唯一的 IP 地址的要求，导致 IP 地址资源告急，为了使 IP 地址资源得到更好的利用，CIDR 出现了

CIDR 表示法：<IP 地址>/<前缀长度>

前缀长度，代表 IP 地址的二进制表现形式下前 $N$ 位为网络地址即其子网掩码为前 $N$ 位为 1 后 $24 - N$ 位为 0

例如：192.168.1.0/24 表示 192.168.1.0 到 192.168.1.255 这 256 个 IP 地址，其中 24 位表示网络号，8 位表示主机号

假设此时有一个企业需要给 2000 台主机分配 IP 地址，直接分配一个 B 类地址会导致浪费过多，可以使用 CIDR 分配 21 bit 作为网络号（x.x.x.0/21），剩下 11 bit 作为主机号， 11 bit 的主机号可以分配 $2^{11}$ 个主机，也就是 2048 个主机，使网络分配更加精准

对于分配到 CIDR 地址块后可以再次将其划分为多个子网，这里有两种划分方式

- **定长子网划分**

在一个 CIDR 地址块中，把长 $n$ 的主机号前 $k$ bit 抠出来作为定长子网号，这样就能划分出 $2^{k}$ 个子网（每个子网包含的 IP 地址块大小相等，每个 IP 地址块大小为 $2^{n - k}$ ）

缺点：每个子网的 IP 地址块大小相同，不能根据需求灵活调整，会导致 IP 地址资源的浪费

![变长子网划分示例](https://store.s1r0ko.top/svg/m/cn/21/6_ver_1.svg)

- **变长子网划分**

在一个 CIDR 地址块中，划分子网时，**子网号长度不固定**（每个子网包含的 IP 地址块大小不同）

::: tip CIDR 地址块的子网划分技巧：可以利用类似“[从根到叶构造二叉哈夫曼树](http://test.com/123.html)”的技巧

- 原始 CIDR 地址块作为根节点（假设可以自由分配的主机号占 $h$ bit）

- 每个分支节点必须同时拥有左右孩子，左 0 右 1 （反过来也行）

- 每个叶子结点对应一个子网，根据根节点到达叶子结点的路径来分析子网对应的 IP 地址块范围

- 整棵树的高度不能超过 $h - 1$ （因为即便最小的子网也至少要保留 2 bit 主机号）

:::

例题：若将 101.200.16.0/20 划分为 5 个子网，则可能的最小子网的可分配 IP 地址数是（）

- A. 126

- **B. 254**{#blue-msg}

- C. 510

- D. 1022

## 路由聚合

根据上面 CIDR 分配的子网得到的拓扑如下：

![路由聚合示例](https://store.s1r0ko.top/svg/m/cn/21/7_ver_1.svg)

由图可见 R0 的路由转发表许多网段都具有相同的网络前缀，并且转发至同一接口，因此这里可以使用路由聚合来合并这几个路由表项，将它们合并为一个路由表项，即 101.200.16.0/20 指向 R0 的接口，这样就可以减少路由表项的数量，提高路由效率

![路由聚合示例](https://store.s1r0ko.top/svg/m/cn/21/8_ver_1.svg)

对于一个路由转发表，如果几条路由表项的转发接口相同，部分网络前缀也相同，那么可以将这几条路由表项聚合为一条。这种地址的聚合称为**路由聚合**，也称为**构成超网**

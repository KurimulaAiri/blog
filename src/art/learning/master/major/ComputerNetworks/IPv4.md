---
title: IPv4
date: 2025-07-23
icon: 'earth-americas'
order: 20
category: 
    - '408'
    - '计算机网络'
    - 考研
---

## IPv4 协议

![各层协议之间关系](https://store.s1r0ko.top/svg/m/cn/20/1_ver_1.svg)

::: tip

各层协议之中， **IP 协议（Internet Protocol）是互联网的核心**{#red-msg}

ARP 协议用于查询同一网络中的 `<主机 IP 地址, MAC 地址>` 之间的映射关系

ICMP 协议用于网络层实体之间互相通知“异常事件”

IGMP 协议用于实现 IP 组播

:::

## IP 数据报的格式

![IP 数据报的格式](//store.s1r0ko.top/svg/m/cn/20/2_ver_2.svg)

IP 数据报分为**首部**和**数据部分**两个部分

首部的结构如图所示

::: info 首部

首部分为固定部分和可变部分两个部分

固定部分长度为 **20 字节**，可变部分长度为 **0 ~ 40 字节不等**

各部分详解：

- 固定部分

| 字段名 | bit 位数 | 说明 |
| ---- | ---- | ---- |
| 版本 | 4 | 用于区分网络层使用的 IP 协议版本，使用二进制表示 4 就是 IPv4 协议，使用二进制表示 6 就是 IPv6 协议 |
| 首部长度 | 4 | 用于指示 IP 数据报的首部长度，单位为 4B，例如：一个首部长度为 20 B 的 IP 数据报，这里的内容为二进制表示的 5 即 $5 \times 4B = 20B$ |
| ~~区分服务~~ | 8 | ~~一般用不到， 408 不考~~ |
| 总长度 | 16 | 表示范围 0 ~ 65535 单位为 1B ，表示整个 IP 数据报的长度（首部 + 数据部分） |
| 标识 | 16 | 由 IP 数据报的“源主机”生成，通常是自增序列，相当于一个数据报的识别码，数据报进行分片时，各分片的标识码必须相同 |
| 标志[^1] | 3 | 三个 bit 分别为三个不同含义，最低位 MF 、 次低位 DF 、 最高位不需要了解意思，具体指代详见脚注 1，假设一个标志位为 001 则分别为最高位、 次低位 MF 、 最低位 DF |
| 片偏移 | 13 | 表示该数据部分在“被分片”之前所处的位置，以 8 B 为单位 |
| 生存时间 | 8 | 代表该数据报在网络中可通过的路由器数的最大值。常记为 TTL[^2] |
| 协议 | 8 | 表示当前数据报正在为哪一个协议服务，如果是 TCP 该值设置为 6 、 如果是 UDP 该值设置为 17 |
| 首部校验和 | 16 | 经过的每个路由器都会对首部进行校验（不校验数据部分），如果该字段全设为 0 ，表示不用校验；校验和的计算方法与 UDP 相同 |
| 源地址 | 32 | 发送主机的 IP 地址 |
| 目的地址 | 32 | 接收主机的 IP 地址 |

[^1]: 标识位含义对照表：
    | 标志位 | 值 | 含义 |
    | --- | --- | --- |
    | MF | 0 | 表示当前分片是 IP 数据报的最后一个分片 |
    | MF | 1 | 表示当前分片不是 IP 数据报的最后一个分片，后面还有分片 |
    | DF | 0 | 表示 IP 数据报可以进行分片 |
    | DF | 1 | 表示 IP 数据报不能进行分片 |

[^2]: 生存时间 TTL ：
    - TTL 的初始值通常由源主机设置
    - 每经过一个路由器， TTL 就会减 1
    - 当 TTL 减为 0 时，该数据报就会被丢弃，并且向源主机发送 ICMP 报文代表发生异常发送失败

- 可变部分

| 字段名 | bit 位数 | 说明 |
| --- | --- | --- |
| 填充 | 不定长 | 用于将 IP 数据报首部填充至 4B 的整数倍 |

:::

::: info 数据部分

数据部分长度范围：0 B ~ ( 65535 - 20 ) B ，扣掉的 20 B 为首部的最小长度，值不需要记

上面只是受到首部总长度字段的限制，也就是**理论最大值**，实际上 IP 数据报的长度通常会受到数据链路层的最短 / 长帧长的限制

:::

一个数据链路层数据帧能承载的最大数据量称为最大传输单元（MTU）。如[以太网帧](/art/learning/master/major/ComputerNetworks/LocalAreaNetwork.html#v2-标准的以太网-mac-帧) MTU = 1500 B

如果一个 IP 数据报总长度超出了下一段链路的 MTU 就需要进行分片处理，依次传递这些分片给下一个节点

拆分时需要注意需要按 MTU 大小减去 IP 数据报的首部长度，得到的数据部分长度才是分片后的数据长度

::: warning

- IP 数据报的“分片”可能在源主机或任何一个路由器中发生

- 只有目的主机才会对分片进行**“重组”**

- 各分片有可能以乱序到达目的主机

- 由于首部“片偏移”字段是以 **8 B** 为单位，因此，除**最后一个分片**外，其他每个分片的数据部分必须是 **8 B** 的整数倍

- **当标志位 DF = 1 且下一段数据链路层数据帧长也无法满足这一份数据报时，路由器会选择丢弃该数据报，并且向源主机发送 ICMP 报文代表发生异常发送失败**{#red-msg}

- 4 1 8，首部长度 4B 为单位，总长度 1B 为单位，片偏移 8B 为单位

:::

## IP 地址详解

IP 地址是一个 32 位的二进制数，通常用点分十进制的形式表示，例如： 192.168.1.1

IP 地址资源由 ICANN（互联网名字与数字分配机构）进行分配（有偿分配），每个 IP 地址都是唯一的，用于标识互联网上的每一个主机

ICANN 将 IP 地址分为以下几类（如图）：

![IP 地址分类](//store.s1r0ko.top/svg/m/cn/20/3_ver_1.svg)





